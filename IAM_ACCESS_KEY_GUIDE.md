# IAM 액세스 키 생성 가이드

## 🔐 액세스 키란?
- AWS API를 프로그래밍 방식으로 사용하기 위한 인증 정보
- **액세스 키 ID** (공개 키): `AKIA...` 형태
- **비밀 액세스 키** (비밀 키): 한 번만 표시되는 긴 문자열

⚠️ **중요**: 비밀 액세스 키는 생성 시 한 번만 표시됩니다!

---

## 📋 방법 1: 새 IAM 사용자 생성 (추천)

### 1단계: IAM 콘솔 접속
1. AWS 콘솔(https://console.aws.amazon.com/) 로그인
2. 검색창에 **"IAM"** 입력 후 클릭
3. 좌측 메뉴에서 **"사용자"** 클릭

### 2단계: 사용자 생성
1. **"사용자 추가"** 또는 **"사용자 생성"** 버튼 클릭

2. **사용자 세부 정보 지정**:
   ```
   사용자 이름: classon-app
   ```

3. **AWS 액세스 유형 선택** (다음 단계에서 권한 설정):
   - "다음" 클릭

### 3단계: 권한 설정
1. **권한 옵션**: "직접 정책 연결" 선택

2. **정책 검색 및 선택**:
   - 검색창에 **"S3"** 입력
   - **"AmazonS3FullAccess"** 체크 ✅

   또는 더 안전한 제한된 권한 (추천):
   - 아래 "사용자 지정 정책" 섹션 참조

3. **"다음"** 클릭

### 4단계: 검토 및 생성
1. 설정 내용 확인
2. **"사용자 생성"** 클릭

### 5단계: 액세스 키 생성
사용자 생성 후:

1. 생성한 사용자 클릭 (classon-app)
2. **"보안 자격 증명"** 탭 선택
3. 아래로 스크롤하여 **"액세스 키"** 섹션 찾기
4. **"액세스 키 만들기"** 버튼 클릭

### 6단계: 사용 사례 선택
**사용 사례 선택** 화면에서:

```
✅ "애플리케이션 서비스" 또는 "로컬 코드" 선택
✅ 하단 체크박스: "위의 권장 사항을 이해했으며..." 체크
```

**"다음"** 클릭

### 7단계: 설명 태그 추가 (선택사항)
```
설명 태그: Class-On 백엔드 S3 업로드용
```

**"액세스 키 만들기"** 클릭

### 8단계: 액세스 키 저장 ⚠️ 중요!
화면에 표시되는 정보를 **반드시 저장**:

```
액세스 키 ID: AKIAIOSFODNN7EXAMPLE
비밀 액세스 키: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

**저장 방법**:
- ✅ **".csv 파일 다운로드"** 버튼 클릭 (추천)
- ✅ 메모장에 복사하여 안전한 곳에 저장
- ⚠️ 이 화면을 벗어나면 비밀 액세스 키를 다시 볼 수 없습니다!

**"완료"** 클릭

---

## 📋 방법 2: 기존 사용자에게 액세스 키 생성

이미 IAM 사용자가 있다면:

### 1단계: IAM 사용자 선택
1. IAM 콘솔 → **"사용자"** 클릭
2. 기존 사용자 선택

### 2단계: 액세스 키 생성
1. **"보안 자격 증명"** 탭
2. **"액세스 키"** 섹션으로 스크롤
3. **"액세스 키 만들기"** 버튼 클릭
4. 위의 "방법 1"의 6-8단계와 동일하게 진행

---

## 📋 방법 3: 루트 계정 액세스 키 (⚠️ 비추천)

보안상 위험하므로 **프로덕션에서는 절대 사용 금지**!
개발/테스트 목적으로만 임시 사용:

### 루트 액세스 키 생성 (권장하지 않음)
1. AWS 콘솔 우측 상단 계정 이름 클릭
2. **"보안 자격 증명"** 선택
3. **"액세스 키"** 섹션 확장
4. **"새 액세스 키 만들기"** 클릭
5. 액세스 키 ID와 비밀 액세스 키 저장

⚠️ **경고**:
- 루트 계정은 모든 권한을 가지므로 매우 위험
- 반드시 IAM 사용자를 만들어 사용하세요

---

## 🔒 제한된 권한 IAM 정책 (추천)

전체 S3 액세스 대신 특정 버킷만 접근하도록 제한:

### IAM 정책 생성
1. IAM → **"정책"** → **"정책 생성"**
2. **"JSON"** 탭 선택
3. 아래 정책 붙여넣기 (버킷 이름 변경):

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::classon-storage-20231206",
                "arn:aws:s3:::classon-storage-20231206/*"
            ]
        }
    ]
}
```

⚠️ **중요**: `classon-storage-20231206`를 실제 버킷 이름으로 변경!

4. **"다음"** 클릭
5. 정책 이름: `ClassonS3Access`
6. **"정책 생성"** 클릭

### 정책을 사용자에게 연결
1. IAM → **"사용자"** → 사용자 선택 (classon-app)
2. **"권한 추가"** → **"정책 직접 연결"**
3. `ClassonS3Access` 검색 후 체크
4. **"권한 추가"** 클릭

---

## 💾 백엔드 환경 변수 설정

### .env 파일 생성
```bash
cd /Users/lee/Desktop/Program/1.\ Web/3.classon/backend
touch .env
```

### .env 파일 내용
```bash
# AWS S3 Configuration
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=ap-northeast-2
S3_BUCKET_NAME=classon-storage-20231206
```

⚠️ **주의**:
- 실제 액세스 키로 변경
- 실제 버킷 이름으로 변경

### .gitignore 확인
.env 파일이 Git에 커밋되지 않도록:

```bash
cd /Users/lee/Desktop/Program/1.\ Web/3.classon/backend
echo ".env" >> .gitignore
```

---

## 🧪 설정 테스트

### 1. 백엔드 서버 재시작
환경 변수를 읽으려면 서버 재시작 필요:

```bash
# 현재 서버 중지 (Ctrl+C)
# 다시 시작
cd /Users/lee/Desktop/Program/1.\ Web/3.classon/backend
source venv/bin/activate
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8002
```

### 2. 프론트엔드에서 테스트
1. 대시보드 → 상품 관리 → **"새 상품 등록"**
2. 썸네일 **"Upload"** 버튼 클릭
3. 이미지 파일 선택
4. ✅ 성공 시: URL 자동 입력됨
5. ❌ 실패 시: 에러 메시지 확인

### 3. 업로드 확인
AWS S3 콘솔에서:
1. S3 → 버킷 선택
2. `instructors/{instructor_id}/images/` 폴더에 파일 확인

---

## 🔧 문제 해결

### 액세스 키를 잊어버렸을 때
- **액세스 키 ID 확인**: IAM → 사용자 → 보안 자격 증명 → 액세스 키 섹션에서 확인 가능
- **비밀 액세스 키 분실**: 다시 볼 수 없음 → **새 액세스 키 생성** 필요
  1. 기존 액세스 키 **"비활성화"** 또는 **"삭제"**
  2. 새 액세스 키 생성
  3. .env 파일 업데이트

### 업로드 실패 시 확인사항
1. ✅ `.env` 파일이 backend 폴더에 있는지
2. ✅ 액세스 키가 올바른지
3. ✅ 버킷 이름이 정확한지
4. ✅ IAM 사용자에게 S3 권한이 있는지
5. ✅ 버킷 정책이 올바르게 설정되었는지
6. ✅ CORS가 설정되었는지
7. ✅ 백엔드 서버를 재시작했는지

### 권한 에러 발생 시
에러 메시지:
```
AccessDenied: Access Denied
```

해결 방법:
1. IAM 사용자 권한 확인
2. 버킷 정책 확인
3. 액세스 키가 올바른 사용자의 것인지 확인

---

## 📱 빠른 체크리스트

설정 완료 확인:

- [ ] IAM 사용자 생성됨
- [ ] 액세스 키 생성됨
- [ ] 액세스 키를 안전하게 저장함
- [ ] S3 버킷 생성됨
- [ ] 버킷 CORS 설정됨
- [ ] 버킷 정책 설정됨 (퍼블릭 읽기 허용)
- [ ] `.env` 파일에 키 입력됨
- [ ] `.env`가 `.gitignore`에 추가됨
- [ ] 백엔드 서버 재시작됨
- [ ] 파일 업로드 테스트 완료

---

## 🔐 보안 주의사항

### 절대 하지 말 것:
- ❌ 액세스 키를 GitHub에 커밋
- ❌ 액세스 키를 공개 웹사이트에 노출
- ❌ 루트 계정 액세스 키 사용 (프로덕션)
- ❌ 액세스 키를 이메일로 전송

### 반드시 할 것:
- ✅ `.env` 파일을 `.gitignore`에 추가
- ✅ IAM 사용자 사용 (루트 계정 X)
- ✅ 최소 권한 원칙 적용
- ✅ 정기적으로 액세스 키 교체 (3-6개월)
- ✅ 의심스러운 활동 발견 시 즉시 키 비활성화

---

## 📚 참고 링크
- AWS IAM 사용자 가이드: https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/
- AWS 액세스 키 모범 사례: https://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html
- AWS S3 보안: https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/security.html
